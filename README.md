# 필사 (pilsa) - 논어 필사 PDF 생성기 & 텔레그램 봇

한자 원문이 희미하게 인쇄된 **습자(Tracing)용 PDF 필사 노트**를 자동 생성합니다. Streamlit 웹 앱 또는 텔레그램 봇을 통해 텍스트를 보내면 즉시 PDF와 이미지 미리보기를 받을 수 있습니다.

## ⚠️ 데이터 보존 및 동기화 주의사항 (중요)

본 프로젝트는 **GitHub를 데이터베이스(DB)**로 활용합니다. 챌린지 기록(`challenge_db.json`)과 사용자 사전(`custom_meanings.json`)은 Git을 통해 관리됩니다.

- **데이터 유실 방지**: 로컬 PC에서 수동으로 `git push`를 하기 전, 반드시 **`git pull origin master`**를 실행하여 서버의 최신 데이터를 먼저 가져오세요. 그렇지 않으면 서버에 쌓인 소중한 기록이 로컬의 구 버전 데이터로 덮어씌워져 초기화될 수 있습니다.
- **권장 방법**: 데이터 동기화는 가급적 **앱 사이드바의 [서버 DB에 최종 저장] 버튼**을 사용하세요. 이 버튼은 자동으로 최신 데이터를 병합(Rebase)한 후 안전하게 업로드하도록 설계되었습니다.

## 주요 기능

- **Streamlit 웹 앱**: 로그인, PDF 생성, 미리보기, 다운로드, 사전 관리, 출석 챌린지를 하나의 웹 인터페이스에서 제공.
- **출석 챌린지 시스템**: PDF를 생성하면 자동으로 출석이 기록되며, 사이드바에서 누적 출석 일수와 명예의 전당(Top 5) 순위를 확인할 수 있습니다.
- **지능적 레이아웃:**
    - 셀 크기 22mm, 줄당 8자 고정 레이아웃으로 일관된 필사 경험 제공.
    - 한글 해석이 길어질 경우 페이지 너비에 맞춰 자동 줄바꿈 처리.
    - 필사 격자(따라쓰기/자유 필사)가 페이지 하단에서 잘리지 않도록 섹션 전체를 다음 페이지로 자동 이동.
- **한자 훈음 자동 표시:**
    - `hanjadict` 라이브러리를 통해 5만 자 이상의 한자 **뜻(훈)과 소리(음)**를 자동으로 조회.
    - **지능적 선택:** 사용자가 입력한 음독 정보를 분석하여 다음자(多音字) 중 문맥에 맞는 정확한 소리를 자동 선택.
    - **사용자 사전 편집 UI:** 사이드바에서 한자 뜻을 직접 수정 및 추가할 수 있는 편집기 제공. 사용자 정의 사전이 자동 사전보다 우선 적용됩니다.
    - **훈음 표시 on/off:** PDF 생성 시 체크박스로 원문 아래 훈음 텍스트 표시 여부를 선택할 수 있습니다 (기본값: 표시). 훈음을 끄더라도 필사 격자 아래 훈음 쓰기 빈 박스는 항상 제공됩니다.
- **PDF 구성 (구절당 1페이지):**
    - **Row 1 (원문):** 진한 한자 원문 + 훈음(선택) + 음독 + 한글 해석
    - **Row 2 (따라쓰기):** 연한 회색 글자 위에 따라 쓰는 격자 + 훈음 쓰기 빈 칸
    - **Row 3 (자유 필사):** 빈 격자 + 훈음 쓰기 빈 칸
    - **Row 4 (해석 필사):** 해석을 직접 써보는 가로줄
- **디자인 가이드:** 격자 셀 내부에 십자(+) 점선 가이드 포함.
- **멀티 채널 지원:** Streamlit 웹 앱, 텔레그램 봇, CLI 환경 지원.

## 설치 및 준비

### 1. 시스템 의존성 설치
PDF를 이미지로 변환하기 위해 `poppler-utils`가 필요합니다.
- **Ubuntu/Debian:** `sudo apt-get install poppler-utils`
- **macOS:** `brew install poppler`

### 2. 파이썬 환경 설정
```bash
python3 -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
```

### 3. 폰트 준비
CJK(한중일) 문자를 지원하는 TTF/OTF 폰트가 필수입니다.
- `fonts/NotoSerifCJKkr-Regular.otf` 경로에 폰트 파일을 반드시 배치해야 합니다.

## 사용법

### 방법 1: Streamlit 웹 앱 (추천)
```bash
streamlit run app.py
```
1. 이름을 입력하고 시작합니다.
2. 왼쪽 패널에 필사 내용을 입력합니다.
3. "훈음 표시" 체크박스로 원문 아래 훈음 표시 여부를 선택합니다 (기본: 표시).
4. "PDF 생성하기" 버튼을 누르면 PDF가 생성되고 출석이 자동 기록됩니다.
5. 오른쪽 패널에서 미리보기 확인 및 PDF 다운로드가 가능합니다.

### 방법 2: 텔레그램 봇
1. `.env` 파일을 생성하고 텔레그램 봇 토큰을 입력합니다.
2. 봇을 실행합니다:
   ```bash
   python telegram_bot.py
   ```
3. 텔레그램에서 텍스트를 보내면 PDF와 미리보기 이미지를 받을 수 있습니다.

### 방법 3: CLI
```bash
python analects_tracing.py --font fonts/NotoSerifCJKkr-Regular.otf --input input.txt
```

## 입력 형식 규칙

| 줄 형식 | 인식 | 예시 |
|---------|------|------|
| `숫자6자리` | 날짜 (무시) | `260210` |
| `숫자.한글` (한자 없음) | 편 정보 | `9.자한편` |
| `숫자.` + 한자 포함 | 구절 원문 | `30.子曰: "知者不惑..."` |
| `(괄호)` | 음독 | `(자왈: "지자불혹...")` |
| 나머지 텍스트 | 해석 | `공자께서 말씀하셨다. "지혜로운..."` |

**입력 예시:**
```
260210
9.자한편
30.子曰: "知者不惑, 仁者不憂, 勇者不懼."
(자왈: "지자불혹, 인자불우, 용자불구.")
공자께서 말씀하셨다. "지혜로운 사람은 미혹되지 않고, 어진 사람은 근심하지 않으며, 용감한 사람은 두려워하지 않는다."
```

## 프로젝트 구조

```
analects-pilsa-bot/
├── app.py                  # Streamlit 웹 앱 (메인 UI)
├── analects_tracing.py     # PDF 생성 엔진 및 CLI
├── hanja_dictionary.py     # 한자 훈음 조회 모듈 (사용자 사전 + hanjadict)
├── challenge_manager.py    # 출석 챌린지 관리 (기록, 통계, 순위)
├── telegram_bot.py         # 텔레그램 봇 서버
├── custom_meanings.json    # 사용자 정의 한자 사전
├── challenge_db.json       # 출석 기록 DB
├── requirements.txt        # 의존성 목록
├── fonts/                  # CJK 폰트 디렉토리
│   └── NotoSerifCJKkr-Regular.otf
└── output/                 # 텔레그램 봇 임시 파일 (Git 제외)
```

## 의존성

| 패키지 | 용도 |
|--------|------|
| `fpdf2` | PDF 생성 |
| `pillow` | 이미지 처리 |
| `pdf2image` | PDF → 이미지 변환 (미리보기) |
| `streamlit` | 웹 앱 UI |
| `hanjadict` | 한자 훈음 자동 조회 (5만+ 한자) |
| `pandas` | 리더보드 테이블 표시 |
| `python-telegram-bot` | 텔레그램 봇 |
| `python-dotenv` | 환경 변수 관리 |
